<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Act 3: Your Hands</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Times New Roman", serif;
      background: #000;
      color: #000;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
      touch-action: none;
    }

    /* Black background with subtle grain */
    #background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 0;
    }

    /* Grain overlay */
    #grain-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      opacity: 0.15;
      pointer-events: none;
      background-image: 
        repeating-radial-gradient(circle at 17% 32%, transparent 0, rgba(255,255,255,.1) 1px, transparent 2px),
        repeating-radial-gradient(circle at 82% 67%, transparent 0, rgba(255,255,255,.08) 1px, transparent 2px),
        repeating-radial-gradient(circle at 45% 78%, transparent 0, rgba(255,255,255,.12) 1px, transparent 2px);
      background-size: 3px 3px, 4px 4px, 5px 5px;
      animation: grain-animation 8s infinite linear;
    }

    @keyframes grain-animation {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-2px, 2px); }
      50% { transform: translate(2px, -2px); }
      75% { transform: translate(-1px, -1px); }
      100% { transform: translate(0, 0); }
    }

    /* Instruction box */
    #instruction-box {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #FFF;
      color: #000;
      border: 1px solid #000;
      padding: 10px;
      font-family: "Courier New", monospace;
      font-size: 13px;
      z-index: 100;
      line-height: 1.4;
      max-width: calc(100vw - 160px);
    }

    /* Navigation button */
    #nav-button {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #999;
      color: #666;
      border: 1px solid #000;
      padding: 10px 20px;
      font-family: "Courier New", monospace;
      font-size: 13px;
      z-index: 100;
      cursor: not-allowed;
      text-decoration: none;
      display: inline-block;
      transition: background 0.3s, color 0.3s;
    }

    #nav-button.enabled {
      background: #FFF;
      color: #000;
      cursor: pointer;
    }

    #nav-button.enabled:hover {
      background: #000;
      color: #FFF;
    }

    /* Dark mode toggle */
    #dark-mode-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #FFF;
      color: #000;
      border: 1px solid #000;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      transition: background 150ms, color 150ms;
    }

    #dark-mode-toggle:hover {
      background: #000;
      color: #FFF;
    }

    /* Responsive layout */
    @media (max-width: 768px) {
      #instruction-box {
        max-width: calc(100vw - 40px);
      }

      #nav-button {
        top: auto;
        right: auto;
        left: 20px;
        bottom: 70px;
      }
    }

    /* Main container */
    #main-container {
      position: relative;
      z-index: 2;
      min-height: 100vh;
      width: 100%;
    }

    /* Definition boxes (starting state) */
    .definition-box {
      position: fixed;
      background: #FFF;
      border: 1px solid #000;
      padding: 30px;
      font-family: "Times New Roman", serif;
      font-size: 16px;
      line-height: 1.8;
      z-index: 10;
      transition: opacity 3s ease-out;
    }

    .definition-box.fading {
      opacity: 0;
    }

    .definition-box p {
      margin-bottom: 15px;
    }

    .definition-box p:last-child {
      margin-bottom: 0;
    }

    .definition-box strong {
      font-weight: normal;
    }

    /* Rectangles */
    .rectangle {
      position: absolute;
      background: #FFF;
      border: 1px solid #000;
      padding: 15px;
      font-family: "Times New Roman", serif;
      font-size: 16px;
      line-height: 1.4;
      cursor: move;
      user-select: none;
      touch-action: none;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      transition: transform 0.5s ease-out, top 0.8s ease-in, left 0.3s ease-out;
      color: transparent;
    }

    .rectangle.falling {
      transition: top 2s cubic-bezier(0.4, 0, 0.6, 1), left 0.5s ease-out;
    }

    .rectangle.dragging {
      z-index: 100;
      cursor: grabbing;
      transition: none;
    }

    .rectangle.placed {
      cursor: default;
      color: #000;
      transition: transform 1s ease-out, color 1s ease-in 0.5s;
    }

    /* House shape with dotted lines */
    #house-shape {
      position: fixed;
      left: 50%;
      top: 50vh;
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: opacity 1s ease-in;
      pointer-events: none;
      z-index: 5;
      margin: 0;
    }

    #house-shape.visible {
      opacity: 1;
    }

    .house-line {
      position: absolute;
      border: 2px dashed rgba(255, 255, 255, 0.5);
      transform-origin: 0 0;
      transition: border-color 0.2s ease;
    }

    .house-line.highlight {
      border-color: rgba(255, 255, 255, 0.9);
      border-width: 3px;
    }

    /* Modal */
    #permission-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.85);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #permission-modal.hidden {
      display: none;
    }

    #modal-content {
      background: #FFF;
      border: 2px solid #000;
      padding: 30px;
      text-align: center;
      font-family: "Courier New", monospace;
      max-width: 400px;
    }

    #modal-content p {
      margin-bottom: 20px;
      font-size: 15px;
      line-height: 1.6;
    }

    #modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    #modal-buttons button {
      font-family: "Courier New", monospace;
      font-size: 14px;
      padding: 10px 20px;
      background: #FFF;
      color: #000;
      border: 1px solid #000;
      cursor: pointer;
      transition: background 150ms, color 150ms;
    }

    #modal-buttons button:hover {
      background: #000;
      color: #FFF;
    }

    /* Hint button */
    #hint-button {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #FFF;
      color: #000;
      border: 1px solid #000;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-family: "Courier New", monospace;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      transition: background 150ms, color 150ms;
    }

    #hint-button:hover {
      background: #000;
      color: #FFF;
    }

    /* Hint modal */
    #hint-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.85);
      z-index: 201;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #hint-modal.hidden {
      display: none;
    }

    #hint-modal-content {
      background: #FFF;
      border: 2px solid #000;
      padding: 30px;
      text-align: center;
      font-family: "Courier New", monospace;
      max-width: 400px;
    }

    #hint-modal-content p {
      margin-bottom: 20px;
      font-size: 15px;
      line-height: 1.6;
    }

    #hint-close {
      font-family: "Courier New", monospace;
      font-size: 14px;
      padding: 10px 20px;
      background: #FFF;
      color: #000;
      border: 1px solid #000;
      cursor: pointer;
      transition: background 150ms, color 150ms;
    }

    #hint-close:hover {
      background: #000;
      color: #FFF;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #instruction-box {
        font-size: 11px;
        padding: 8px;
        max-width: calc(100vw - 40px);
      }

      .definition-box {
        padding: 20px;
        font-size: 14px;
        line-height: 1.6;
      }

      .rectangle {
        padding: 10px;
        font-size: 13px;
        line-height: 1.3;
      }

      #house-shape {
        transform: translate(-50%, -50%) scale(0.7);
      }
      
      .rectangle {
        width: 180px;
        height: 50px;
      }
    }
  </style>
</head>
<body>
  <!-- Black background -->
  <div id="background"></div>

  <!-- Grain overlay -->
  <div id="grain-overlay"></div>

  <!-- Instruction box -->
  <div id="instruction-box">
    ACT 3: Your hands language home
  </div>

  <!-- Navigation button -->
  <a id="nav-button" href="https://immigrantjustice.org/for-immigrants/know-your-rights/ice-encounter/">place</a>

  <!-- Dark mode toggle -->
  <div id="dark-mode-toggle">☀</div>

  <!-- Hint button -->
  <div id="hint-button">?</div>

  <!-- Main container -->
  <div id="main-container">
    <!-- Definition boxes will be added here -->
    <!-- House shape will be added here -->
    <!-- Rectangles will be added here -->
  </div>

  <!-- Permission modal -->
  <div id="permission-modal">
    <div id="modal-content">
      <p>Will you build with us?<br>(Hands required)</p>
      <div id="modal-buttons">
        <button id="btn-yes">Yes</button>
        <button id="btn-no">No</button>
      </div>
    </div>
  </div>

  <!-- Hint modal -->
  <div id="hint-modal" class="hidden">
    <div id="hint-modal-content">
      <p>Hint: Drag in order.</p>
      <button id="hint-close">Close</button>
    </div>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const RECTANGLE_WIDTH = 200;
    const RECTANGLE_HEIGHT = 60;
    const SNAP_THRESHOLD = 80; // Distance threshold for snapping (increased for mobile)

    // ==================== TEXT CONTENT ====================
    const ORIGINAL_SECTIONS = [
      "It's been twenty years and change",
      "And change, and you thought it easy",
      "to close the mouth of a wound",
      "but now all you think about is love",
      "And money. And maybe",
      "you too were elected snake in this garden",
      "and so you slither against",
      "the warm hilltop rocks of longing"
    ];
    
    const DARK_TEXT = "Once non-criminal illegal aliens submit their intent to depart through the CBP Home Mobile App and pass vetting, they will be temporarily deprioritized by ICE for detention or enforcement action before their scheduled departure. Image Financial and travel document assistance for those in need Illegal aliens who register for voluntary self-departure through the CBP Home Mobile App will receive cost-free travel, a $1,000 exit bonus, and forgiveness of any failure to depart fines. Illegal aliens requesting assistance will have a timely departure arranged for them.";
    
    const DARK_SECTIONS = DARK_TEXT.split(/\s+/).filter(t => t.length > 0);
    
    // Pad or truncate to 8 sections
    const DARK_TEXT_SECTIONS = [];
    const wordsPerSection = Math.ceil(DARK_SECTIONS.length / 8);
    for (let i = 0; i < 8; i++) {
      const start = i * wordsPerSection;
      const end = Math.min(start + wordsPerSection, DARK_SECTIONS.length);
      DARK_TEXT_SECTIONS.push(DARK_SECTIONS.slice(start, end).join(' '));
    }
    
    let TEXT_SECTIONS = [...ORIGINAL_SECTIONS];
    let isDarkMode = false;

    // House shape definition (8 lines forming a simple house)
    // Each line: { x1, y1, x2, y2, angle, length, midX, midY, index }
    const HOUSE_LINES = [];

    // ==================== STATE ====================
    let rectangles = [];
    let houseLinesElements = [];
    let placedCount = 0;
    let nextPlacementIndex = 0; // Track which text to show next (sequential placement)
    let draggedElement = null;
    let offsetX = 0;
    let offsetY = 0;
    let currentHighlightedLine = null;
    let baseZIndex = 50; // Base z-index for placed rectangles

    // ==================== DOM ELEMENTS ====================
    const modal = document.getElementById('permission-modal');
    const btnYes = document.getElementById('btn-yes');
    const btnNo = document.getElementById('btn-no');
    const hintButton = document.getElementById('hint-button');
    const hintModal = document.getElementById('hint-modal');
    const hintClose = document.getElementById('hint-close');
    const navButton = document.getElementById('nav-button');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const mainContainer = document.getElementById('main-container');

    // ==================== INITIALIZATION ====================
    function init() {
      // Create initial definition boxes
      createDefinitionBoxes();

      // Modal event listeners
      btnYes.addEventListener('click', handleYes);
      btnNo.addEventListener('click', handleNo);
      hintButton.addEventListener('click', () => {
        hintModal.classList.remove('hidden');
      });
      hintClose.addEventListener('click', () => {
        hintModal.classList.add('hidden');
      });
      
      // Dark mode toggle
      darkModeToggle.addEventListener('click', () => {
        isDarkMode = !isDarkMode;
        toggleDarkMode();
      });
      
      // Prevent nav button click when disabled
      navButton.addEventListener('click', (e) => {
        if (!navButton.classList.contains('enabled')) {
          e.preventDefault();
        }
      });
    }

    // ==================== CREATE DEFINITION BOXES ====================
    function createDefinitionBoxes() {
      // Top box
      const topBox = document.createElement('div');
      topBox.className = 'definition-box';
      topBox.id = 'top-box';
      topBox.innerHTML = `<p><strong>Displacement:</strong> Softer replacement.</p>
<p><strong>Words:</strong> Language powder ripping the day open like commerce, pieces of melancholy.</p>
<p><strong>Identity:</strong> The unintended byproduct of the words you use, a lease on an unabridged self.</p>`;
      
      // Position at top
      topBox.style.left = '50%';
      topBox.style.transform = 'translateX(-50%)';
      topBox.style.top = '100px';
      topBox.style.width = '600px';
      topBox.style.maxWidth = 'calc(100vw - 40px)';
      
      mainContainer.appendChild(topBox);

      // Bottom box
      const bottomBox = document.createElement('div');
      bottomBox.className = 'definition-box';
      bottomBox.id = 'bottom-box';
      bottomBox.innerHTML = `<p><strong>Body:</strong> Incongruency making due with the motherly press of gravity.</p>
<p><strong>Words:</strong> Rooming into your mouth, pushing sound against the inside of your cheeks like a rougher lover.</p>
<p><strong>Replacement:</strong> Rougher displacement.</p>`;
      
      // Position at bottom
      bottomBox.style.left = '50%';
      bottomBox.style.transform = 'translateX(-50%)';
      bottomBox.style.bottom = '100px';
      bottomBox.style.width = '600px';
      bottomBox.style.maxWidth = 'calc(100vw - 40px)';
      
      mainContainer.appendChild(bottomBox);
    }

    // ==================== MODAL HANDLERS ====================
    function handleYes() {
      console.log('Starting transformation...');
      modal.classList.add('hidden');
      
      // Fade out text in boxes
      const topBox = document.getElementById('top-box');
      const bottomBox = document.getElementById('bottom-box');
      
      topBox.classList.add('fading');
      bottomBox.classList.add('fading');
      
      // After 3 seconds, break into rectangles
      setTimeout(() => {
        breakIntoRectangles();
      }, 3000);
    }

    function handleNo() {
      modal.querySelector('p').textContent = 'You must home to continue.';
      modal.querySelector('#modal-buttons').style.display = 'none';
    }

    // ==================== BREAK INTO RECTANGLES ====================
    function breakIntoRectangles() {
      console.log('Breaking into rectangles...');
      
      // Get position of definition boxes before removing
      const topBox = document.getElementById('top-box');
      const bottomBox = document.getElementById('bottom-box');
      const topBounds = topBox.getBoundingClientRect();
      const bottomBounds = bottomBox.getBoundingClientRect();
      
      // Remove definition boxes
      topBox.remove();
      bottomBox.remove();
      
      // Create 8 rectangles - replace the definition boxes
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const centerX = viewportWidth / 2 - RECTANGLE_WIDTH / 2;
      const bottomY = viewportHeight - 150;
      
      for (let i = 0; i < 8; i++) {
        const rect = document.createElement('div');
        rect.className = 'rectangle';
        rect.dataset.index = i;
        // Don't show text yet - will appear when placed
        rect.textContent = '';
        
        // Start at center of either top or bottom box
        const startX = centerX;
        const startY = i < 4 ? topBounds.top + topBounds.height / 2 - RECTANGLE_HEIGHT / 2 : bottomBounds.top + bottomBounds.height / 2 - RECTANGLE_HEIGHT / 2;
        
        rect.style.left = `${startX}px`;
        rect.style.top = `${startY}px`;
        rect.style.width = `${RECTANGLE_WIDTH}px`;
        rect.style.height = `${RECTANGLE_HEIGHT}px`;
        
        mainContainer.appendChild(rect);
        rectangles.push({
          element: rect,
          index: i,
          placed: false
        });
        
        // Start falling animation after a brief delay - all fall to bottom center
        setTimeout(() => {
          rect.classList.add('falling');
          rect.style.left = `${centerX}px`;
          rect.style.top = `${bottomY - (7 - i) * 10}px`; // Stack them slightly
        }, 100 + i * 100);
      }
      
      // After falling completes, show house and enable dragging
      setTimeout(() => {
        createHouseShape();
        enableDragging();
      }, 2000);
    }

    // ==================== CREATE HOUSE SHAPE ====================
    function createHouseShape() {
      console.log('Creating house shape...');
      
      const houseContainer = document.createElement('div');
      houseContainer.id = 'house-shape';
      mainContainer.appendChild(houseContainer);
      
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // Scale house based on viewport - made larger
      const scale = Math.min(viewportWidth / 700, viewportHeight / 700, 1.0);
      const baseWidth = 450 * scale;
      const baseHeight = 350 * scale;
      const roofHeight = 140 * scale;
      
      // Define house shape: 2 top slanted, 4 middle vertical, 2 bottom horizontal
      const lines = [
        // TOP: 2 slanted roof lines
        { x1: 0, y1: roofHeight, x2: baseWidth / 2, y2: 0, index: 0, section: 'top' }, // Left roof
        { x1: baseWidth / 2, y1: 0, x2: baseWidth, y2: roofHeight, index: 1, section: 'top' }, // Right roof
        
        // MIDDLE: 4 vertical lines
        { x1: baseWidth * 0.15, y1: roofHeight, x2: baseWidth * 0.15, y2: roofHeight + baseHeight, index: 2, section: 'middle' },
        { x1: baseWidth * 0.38, y1: roofHeight, x2: baseWidth * 0.38, y2: roofHeight + baseHeight, index: 3, section: 'middle' },
        { x1: baseWidth * 0.62, y1: roofHeight, x2: baseWidth * 0.62, y2: roofHeight + baseHeight, index: 4, section: 'middle' },
        { x1: baseWidth * 0.85, y1: roofHeight, x2: baseWidth * 0.85, y2: roofHeight + baseHeight, index: 5, section: 'middle' },
        
        // BOTTOM: 2 horizontal lines
        { x1: 0, y1: roofHeight + baseHeight, x2: baseWidth / 2, y2: roofHeight + baseHeight, index: 6, section: 'bottom' }, // Left floor
        { x1: baseWidth / 2, y1: roofHeight + baseHeight, x2: baseWidth, y2: roofHeight + baseHeight, index: 7, section: 'bottom' } // Right floor
      ];
      
      lines.forEach((line) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'house-line';
        lineEl.dataset.lineIndex = line.index;
        
        const length = Math.sqrt(
          Math.pow(line.x2 - line.x1, 2) + Math.pow(line.y2 - line.y1, 2)
        );
        const angle = Math.atan2(line.y2 - line.y1, line.x2 - line.x1) * (180 / Math.PI);
        
        lineEl.style.width = `${length}px`;
        lineEl.style.height = '0';
        lineEl.style.borderBottom = '2px dashed rgba(255, 255, 255, 0.5)';
        lineEl.style.borderTop = 'none';
        lineEl.style.borderLeft = 'none';
        lineEl.style.borderRight = 'none';
        lineEl.style.left = `${line.x1}px`;
        lineEl.style.top = `${line.y1}px`;
        lineEl.style.transform = `rotate(${angle}deg)`;
        
        houseContainer.appendChild(lineEl);
        
        // Store line data for snapping
        HOUSE_LINES.push({
          ...line,
          angle: angle,
          length: length,
          midX: (line.x1 + line.x2) / 2,
          midY: (line.y1 + line.y2) / 2,
          element: lineEl
        });
      });
      
      // Show house
      setTimeout(() => {
        houseContainer.classList.add('visible');
      }, 100);
    }

    // ==================== ENABLE DRAGGING ====================
    function enableDragging() {
      rectangles.forEach(rectData => {
        const rect = rectData.element;
        
        // Mouse events
        rect.addEventListener('mousedown', startDrag);
        
        // Touch events
        rect.addEventListener('touchstart', startDrag, { passive: false });
      });
      
      // Global move and end events
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', endDrag);
      document.addEventListener('touchmove', drag, { passive: false });
      document.addEventListener('touchend', endDrag);
    }

    function startDrag(e) {
      const rect = e.target.closest('.rectangle');
      if (!rect || rectangles.find(r => r.element === rect).placed) return;
      
      e.preventDefault();
      e.stopPropagation();
      draggedElement = rect;
      rect.classList.add('dragging');
      
      const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
      const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
      
      const rectBounds = rect.getBoundingClientRect();
      offsetX = clientX - rectBounds.left;
      offsetY = clientY - rectBounds.top;
      
      console.log('Started dragging rectangle');
    }

    function drag(e) {
      if (!draggedElement) return;
      e.preventDefault();
      e.stopPropagation();
      
      const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
      const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
      
      draggedElement.style.left = `${clientX - offsetX}px`;
      draggedElement.style.top = `${clientY - offsetY}px`;
      
      // Highlight closest available line
      highlightClosestLine(clientX, clientY);
    }
    
    function highlightClosestLine(clientX, clientY) {
      const houseContainer = document.getElementById('house-shape');
      if (!houseContainer) return;
      
      const houseContainerBounds = houseContainer.getBoundingClientRect();
      
      let closestLine = null;
      let closestDistance = Infinity;
      
      HOUSE_LINES.forEach(line => {
        // Check if this line is already occupied
        const alreadyPlaced = rectangles.some(
          r => r.placed && r.lineIndex === line.index
        );
        if (alreadyPlaced) return;
        
        const lineMidX = houseContainerBounds.left + line.midX;
        const lineMidY = houseContainerBounds.top + line.midY;
        
        const distance = Math.sqrt(
          Math.pow(clientX - lineMidX, 2) + Math.pow(clientY - lineMidY, 2)
        );
        
        if (distance < closestDistance && distance < SNAP_THRESHOLD) {
          closestDistance = distance;
          closestLine = line;
        }
      });
      
      // Remove previous highlight
      if (currentHighlightedLine && currentHighlightedLine !== closestLine) {
        currentHighlightedLine.element.classList.remove('highlight');
      }
      
      // Add new highlight
      if (closestLine) {
        closestLine.element.classList.add('highlight');
        currentHighlightedLine = closestLine;
      } else {
        currentHighlightedLine = null;
      }
    }

    function endDrag(e) {
      if (!draggedElement) return;
      
      const rect = draggedElement;
      const rectData = rectangles.find(r => r.element === rect);
      const rectIndex = parseInt(rect.dataset.index);
      
      // Check if near any house line
      const rectBounds = rect.getBoundingClientRect();
      const rectCenterX = rectBounds.left + rectBounds.width / 2;
      const rectCenterY = rectBounds.top + rectBounds.height / 2;
      
      const houseContainer = document.getElementById('house-shape');
      const houseContainerBounds = houseContainer.getBoundingClientRect();
      
      let closestLine = null;
      let closestDistance = Infinity;
      
      HOUSE_LINES.forEach(line => {
        // Check if this line is already occupied
        const alreadyPlaced = rectangles.some(
          r => r.placed && r.lineIndex === line.index
        );
        if (alreadyPlaced) return;
        
        const lineMidX = houseContainerBounds.left + line.midX;
        const lineMidY = houseContainerBounds.top + line.midY;
        
        const distance = Math.sqrt(
          Math.pow(rectCenterX - lineMidX, 2) + Math.pow(rectCenterY - lineMidY, 2)
        );
        
        if (distance < closestDistance) {
          closestDistance = distance;
          closestLine = line;
        }
      });
      
      if (closestLine && closestDistance < SNAP_THRESHOLD) {
        // Snap to line
        snapToLine(rect, rectData, closestLine);
      }
      
      // Clear highlight
      if (currentHighlightedLine) {
        currentHighlightedLine.element.classList.remove('highlight');
        currentHighlightedLine = null;
      }
      
      rect.classList.remove('dragging');
      draggedElement = null;
    }

    function snapToLine(rect, rectData, line) {
      console.log(`Snapping rectangle to line ${line.index}, showing text #${nextPlacementIndex}: "${TEXT_SECTIONS[nextPlacementIndex]}"`);
      
      const houseContainer = document.getElementById('house-shape');
      const houseContainerBounds = houseContainer.getBoundingClientRect();
      
      // Position rectangle at line's midpoint
      const lineMidX = houseContainerBounds.left + line.midX;
      const lineMidY = houseContainerBounds.top + line.midY;
      
      rect.style.left = `${lineMidX - RECTANGLE_WIDTH / 2}px`;
      rect.style.top = `${lineMidY - RECTANGLE_HEIGHT / 2}px`;
      rect.style.transform = `rotate(${line.angle}deg)`;
      
      // Set z-index so latest placed is on top
      baseZIndex++;
      rect.style.zIndex = baseZIndex;
      
      // Show text from sequential index
      rect.textContent = TEXT_SECTIONS[nextPlacementIndex];
      
      // Mark as placed
      rect.classList.add('placed');
      rectData.placed = true;
      rectData.lineIndex = line.index;
      rectData.textIndex = nextPlacementIndex;
      
      nextPlacementIndex++;
      placedCount++;
      
      // Check if all placed
      if (placedCount === 8) {
        setTimeout(() => {
          onAllPlaced();
        }, 1000);
      }
    }

    function onAllPlaced() {
      console.log('✓ All rectangles placed! House complete. Enabling navigation.');
      navButton.classList.add('enabled');
    }

    // ==================== DARK MODE TOGGLE ====================
    function toggleDarkMode() {
      if (isDarkMode) {
        // Switch to dark mode
        darkModeToggle.textContent = '☁︎';
        navButton.textContent = 'Protection';
        navButton.href = 'https://www.dhs.gov/cbphome';
        document.getElementById('instruction-box').textContent = 'ACT 3: Voluntary Departure Program';
        TEXT_SECTIONS = [...DARK_TEXT_SECTIONS];
      } else {
        // Switch back to light mode
        darkModeToggle.textContent = '☀';
        navButton.textContent = 'place';
        navButton.href = 'https://immigrantjustice.org/for-immigrants/know-your-rights/ice-encounter/';
        document.getElementById('instruction-box').textContent = 'ACT 3: Your hands language home';
        TEXT_SECTIONS = [...ORIGINAL_SECTIONS];
      }
      
      // Update definition boxes if they exist
      replaceDefinitionBoxes();
      
      // Update placed rectangles if they exist
      replacePlacedRectangles();
    }
    
    function replaceDefinitionBoxes() {
      const defBoxes = document.querySelectorAll('.definition-box');
      defBoxes.forEach((box) => {
        if (isDarkMode) {
          box.style.background = '#000';
          box.style.color = '#FFF';
        } else {
          box.style.background = '#FFF';
          box.style.color = '#000';
        }
      });
    }
    
    function replacePlacedRectangles() {
      rectangles.forEach((rectData) => {
        const rect = rectData.element;
        
        if (isDarkMode) {
          rect.style.background = '#000';
          rect.style.color = '#FFF';
          rect.style.border = '1px solid #FFF';
          // Update text if placed
          if (rectData.placed && rectData.textIndex !== undefined) {
            rect.textContent = TEXT_SECTIONS[rectData.textIndex] || '';
          }
        } else {
          rect.style.background = '#FFF';
          rect.style.color = '#000';
          rect.style.border = '1px solid #000';
          if (rectData.placed && rectData.textIndex !== undefined) {
            rect.textContent = TEXT_SECTIONS[rectData.textIndex] || '';
          }
        }
      });
    }

    // ==================== START ====================
    init();
  </script>
</body>
</html>

