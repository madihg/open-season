<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Act 2: Your Voice</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Times New Roman", serif;
      background: #000;
      color: #000;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* Black background with subtle grain */
    #background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 0;
    }

    /* Grain overlay */
    #grain-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      opacity: 0.15;
      pointer-events: none;
      background-image: 
        repeating-radial-gradient(circle at 17% 32%, transparent 0, rgba(255,255,255,.1) 1px, transparent 2px),
        repeating-radial-gradient(circle at 82% 67%, transparent 0, rgba(255,255,255,.08) 1px, transparent 2px),
        repeating-radial-gradient(circle at 45% 78%, transparent 0, rgba(255,255,255,.12) 1px, transparent 2px);
      background-size: 3px 3px, 4px 4px, 5px 5px;
      animation: grain-animation 8s infinite linear;
    }

    @keyframes grain-animation {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-2px, 2px); }
      50% { transform: translate(2px, -2px); }
      75% { transform: translate(-1px, -1px); }
      100% { transform: translate(0, 0); }
    }

    /* Instruction box */
    #instruction-box {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #FFF;
      color: #000;
      border: 1px solid #000;
      padding: 10px;
      font-family: "Courier New", monospace;
      font-size: 13px;
      z-index: 100;
      line-height: 1.4;
    }

    /* Words container */
    #words-container {
      position: relative;
      z-index: 2;
      min-height: 100vh;
      padding-top: 120px;
      padding-bottom: 60px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    #words-grid {
      display: grid;
      grid-template-columns: repeat(6, max-content);
      column-gap: 24px;
      justify-content: center;
    }

    .word-column {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .word-box {
      background: #FFF;
      border: 1px solid #000;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-family: "Times New Roman", serif;
      font-size: 16px;
      line-height: 1.2;
      opacity: 1;
    }

    /* Hidden measurement span */
    #measurement-span {
      position: absolute;
      visibility: hidden;
      white-space: nowrap;
      font-family: "Times New Roman", serif;
      font-size: 16px;
      padding: 6px 10px;
      border: 1px solid #000;
      line-height: 1.2;
    }

    /* Modal */
    #permission-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.85);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #permission-modal.hidden {
      display: none;
    }

    #modal-content {
      background: #FFF;
      border: 2px solid #000;
      padding: 30px;
      text-align: center;
      font-family: "Courier New", monospace;
      max-width: 400px;
    }

    #modal-content p {
      margin-bottom: 20px;
      font-size: 15px;
      line-height: 1.6;
    }

    #modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    #modal-buttons button {
      font-family: "Courier New", monospace;
      font-size: 14px;
      padding: 10px 20px;
      background: #FFF;
      color: #000;
      border: 1px solid #000;
      cursor: pointer;
      transition: background 150ms, color 150ms;
    }

    #modal-buttons button:hover {
      background: #000;
      color: #FFF;
    }

    /* Hint button */
    #hint-button {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #FFF;
      color: #000;
      border: 1px solid #000;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-family: "Courier New", monospace;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      transition: background 150ms, color 150ms;
    }

    #hint-button:hover {
      background: #000;
      color: #FFF;
    }

    /* Hint modal */
    #hint-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.85);
      z-index: 201;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #hint-modal.hidden {
      display: none;
    }

    #hint-modal-content {
      background: #FFF;
      border: 2px solid #000;
      padding: 30px;
      text-align: center;
      font-family: "Courier New", monospace;
      max-width: 400px;
    }

    #hint-modal-content p {
      margin-bottom: 20px;
      font-size: 15px;
      line-height: 1.6;
    }

    #hint-close {
      font-family: "Courier New", monospace;
      font-size: 14px;
      padding: 10px 20px;
      background: #FFF;
      color: #000;
      border: 1px solid #000;
      cursor: pointer;
      transition: background 150ms, color 150ms;
    }

    #hint-close:hover {
      background: #000;
      color: #FFF;
    }

    /* Curtain animation states */
    .word-column {
      transition: opacity 1s ease-in-out;
    }

    .word-box {
      transition: transform 3s ease-in-out, opacity 1s ease-in-out;
    }

    /* Definition boxes (appear after curtains open) */
    .definition-box {
      position: fixed;
      background: #FFF;
      border: 1px solid #000;
      padding: 30px;
      font-family: "Times New Roman", serif;
      font-size: 16px;
      line-height: 1.8;
      opacity: 0;
      transition: opacity 2s ease-in;
      z-index: 50;
      box-sizing: border-box;
    }

    .definition-box.visible {
      opacity: 1;
    }

    .definition-box p {
      margin-bottom: 15px;
    }

    .definition-box p:last-child {
      margin-bottom: 0;
    }

    .definition-box strong {
      font-weight: normal;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #instruction-box {
        font-size: 11px;
        padding: 8px;
        max-width: calc(100vw - 40px);
      }

      #words-container {
        padding-top: 100px;
      }

      .definition-box {
        padding: 20px;
        font-size: 14px;
        line-height: 1.6;
      }
    }
  </style>
</head>
<body>
  <!-- Black background -->
  <div id="background"></div>

  <!-- Grain overlay -->
  <div id="grain-overlay"></div>

  <!-- Instruction box -->
  <div id="instruction-box">
    ACT 2: Your voice glossaries belongings
  </div>

  <!-- Hint button -->
  <div id="hint-button">?</div>

  <!-- Permission modal -->
  <div id="permission-modal">
    <div id="modal-content">
      <p>Will you sing with us?<br>(Microphone required)</p>
      <div id="modal-buttons">
        <button id="btn-yes">Yes</button>
        <button id="btn-no">No</button>
      </div>
    </div>
  </div>

  <!-- Hint modal -->
  <div id="hint-modal" class="hidden">
    <div id="hint-modal-content">
      <p>Hint: Louder is better.</p>
      <button id="hint-close">Close</button>
    </div>
  </div>

  <!-- Words container -->
  <div id="words-container">
    <div id="words-grid">
      <div class="word-column" data-col="0"></div>
      <div class="word-column" data-col="1"></div>
      <div class="word-column" data-col="2"></div>
      <div class="word-column" data-col="3"></div>
      <div class="word-column" data-col="4"></div>
      <div class="word-column" data-col="5"></div>
    </div>
  </div>

  <!-- Measurement span -->
  <span id="measurement-span"></span>

  <script>
    // ==================== CONFIGURATION ====================
    const NUM_COLUMNS = 6;
    const VOICE_THRESHOLD = 0.02; // Volume threshold to detect speech
    const VOICE_SMOOTHING = 0.4; // EMA smoothing (increased for slower response)
    const CURTAIN_OPEN_DISTANCE = 200; // How far rows move apart (pixels)
    const TOP_ROWS = 8; // Number of rows in top section (rows 0-7)
    const BOTTOM_ROWS = 9; // Remaining rows in bottom section (rows 8-16, for 17 total rows)

    // ==================== TEXT CONTENT (from ACT 1) ====================
    const TEXT = "The first exodus is yours. You open a season. Rush where the angels were afraid to go. Complete a course in impossibility. And now the words you use are ripe, full, sugar, their skin the domestic tempting of cosmic crisps. But have you eaten? Have you noticed how the siren song of apple flesh gorged on rain glisten-calls your name until your teeth give in, how hunger sounds like a country ready to forget you? How the words you use now huffpuff as they shore up your international body.";
    
    const tokens = TEXT.split(/\s+/).filter(t => t.length > 0);

    // ==================== STATE ====================
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let animationId = null;
    let volumeEMA = 0;
    let curtainsOpen = false;
    let curtainsOpening = false;
    let totalSpeechTime = 0;
    let curtainOpenThreshold = 5000; // 5 seconds of speech to fully open curtains (slower response)
    let allWordBoxes = []; // Track all word boxes with their row indices

    // ==================== DOM ELEMENTS ====================
    const modal = document.getElementById('permission-modal');
    const btnYes = document.getElementById('btn-yes');
    const btnNo = document.getElementById('btn-no');
    const hintButton = document.getElementById('hint-button');
    const hintModal = document.getElementById('hint-modal');
    const hintClose = document.getElementById('hint-close');
    const wordsGrid = document.getElementById('words-grid');
    const wordColumns = Array.from(document.querySelectorAll('.word-column'));
    const measurementSpan = document.getElementById('measurement-span');

    // ==================== INITIALIZATION ====================
    function init() {
      console.log(`Total tokens: ${tokens.length}, Total rows: ${Math.ceil(tokens.length / NUM_COLUMNS)}`);
      
      // Set up column widths
      setupColumnWidths();
      
      // Render all words immediately
      renderAllWords();

      // Modal event listeners
      btnYes.addEventListener('click', handleYes);
      btnNo.addEventListener('click', handleNo);
      hintButton.addEventListener('click', () => {
        hintModal.classList.remove('hidden');
      });
      hintClose.addEventListener('click', () => {
        hintModal.classList.add('hidden');
      });
    }

    // ==================== COLUMN WIDTH SETUP ====================
    function setupColumnWidths() {
      // Group tokens by column
      const columnTokens = Array.from({ length: NUM_COLUMNS }, () => []);
      tokens.forEach((token, idx) => {
        const colIdx = idx % NUM_COLUMNS;
        columnTokens[colIdx].push(token);
      });

      // Measure max width per column
      columnTokens.forEach((colTokens, colIdx) => {
        let maxWidth = 0;
        colTokens.forEach(token => {
          measurementSpan.textContent = token;
          const width = measurementSpan.offsetWidth;
          if (width > maxWidth) maxWidth = width;
        });
        
        // Set CSS variable for this column
        const column = wordColumns[colIdx];
        column.style.setProperty('--colw', `${maxWidth}px`);
        column.style.width = `${maxWidth}px`;
      });
    }

    // ==================== RENDER ALL WORDS ====================
    function renderAllWords() {
      tokens.forEach((token, idx) => {
        const colIdx = idx % NUM_COLUMNS;
        const rowIdx = Math.floor(idx / NUM_COLUMNS);
        const column = wordColumns[colIdx];
        
        // Create word box
        const wordBox = document.createElement('div');
        wordBox.className = 'word-box';
        wordBox.textContent = token;
        wordBox.dataset.row = rowIdx;
        column.appendChild(wordBox);
        
        // Track for curtain animation
        allWordBoxes.push({
          element: wordBox,
          row: rowIdx,
          col: colIdx,
          index: idx
        });
      });
    }

    // ==================== MODAL HANDLERS ====================
    async function handleYes() {
      try {
        console.log('Requesting microphone access...');
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Set up Web Audio API
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        analyser.smoothingTimeConstant = 0.8;
        
        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        
        console.log('✓ Microphone connected!');
        modal.classList.add('hidden');
        
        // Start audio monitoring
        startAudioMonitoring();
      } catch (err) {
        console.error('Error accessing microphone:', err);
        alert('Could not access microphone. Please check permissions.');
      }
    }

    function handleNo() {
      modal.querySelector('p').textContent = 'Your voice is required to continue.';
      modal.querySelector('#modal-buttons').style.display = 'none';
    }

    // ==================== AUDIO MONITORING ====================
    function startAudioMonitoring() {
      const dataArray = new Uint8Array(analyser.frequencyBinCount);
      let lastTime = performance.now();

      function loop() {
        const now = performance.now();
        const delta = now - lastTime;
        lastTime = now;

        // Get volume level
        analyser.getByteFrequencyData(dataArray);
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          sum += dataArray[i];
        }
        const average = sum / dataArray.length / 255; // Normalize to 0-1
        
        // Update EMA
        volumeEMA = volumeEMA * (1 - VOICE_SMOOTHING) + average * VOICE_SMOOTHING;

        // Check if speaking
        if (volumeEMA > VOICE_THRESHOLD && !curtainsOpen) {
          totalSpeechTime += delta;
          
          if (!curtainsOpening) {
            curtainsOpening = true;
            console.log('🎙️ Voice detected! Opening curtains...');
          }

          // Calculate curtain progress (0 to 1)
          const progress = Math.min(totalSpeechTime / curtainOpenThreshold, 1);
          updateCurtains(progress);

          // Check if curtains fully open
          if (progress >= 1 && !curtainsOpen) {
            curtainsOpen = true;
            console.log('✓ Curtains fully open!');
            setTimeout(() => {
              transformToDefinitions();
            }, 3000); // Wait for animation to complete
          }
        }

        // Debug logging
        if (Math.random() < 0.02) {
          console.log(`Volume: ${average.toFixed(4)}, EMA: ${volumeEMA.toFixed(4)}, Speech time: ${(totalSpeechTime/1000).toFixed(1)}s`);
        }

        if (!curtainsOpen) {
          animationId = requestAnimationFrame(loop);
        }
      }

      loop();
    }

    // ==================== CURTAIN ANIMATION ====================
    function updateCurtains(progress) {
      // Easing function for smooth curtain movement
      const eased = easeInOutCubic(progress);
      
      // Move top rows upward, bottom rows downward
      const offset = CURTAIN_OPEN_DISTANCE * eased;
      
      allWordBoxes.forEach(wordData => {
        if (wordData.row < TOP_ROWS) {
          // Top section moves up
          wordData.element.style.transform = `translateY(${-offset}px)`;
        } else {
          // Bottom section moves down
          wordData.element.style.transform = `translateY(${offset}px)`;
        }
      });
    }

    function easeInOutCubic(t) {
      return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
    }

    // ==================== TRANSFORM TO DEFINITIONS ====================
    function transformToDefinitions() {
      console.log('Transforming to definition boxes...');
      
      // Calculate bounding boxes for top and bottom groups
      const topBounds = calculateGroupBoundsByRows(0, TOP_ROWS);
      const bottomBounds = calculateGroupBoundsByRows(TOP_ROWS, TOP_ROWS + BOTTOM_ROWS);
      
      console.log('Top bounds:', topBounds);
      console.log('Bottom bounds:', bottomBounds);
      
      // Fade out word boxes
      allWordBoxes.forEach(wordData => {
        wordData.element.style.opacity = '0';
      });

      // Wait for fade out, then create definition boxes
      setTimeout(() => {
        createDefinitionBox('top', topBounds, `<p><strong>Displacement:</strong> Softer replacement.</p>
<p><strong>Words:</strong> Language powder ripping the day open like commerce, pieces of melancholy.</p>
<p><strong>Identity:</strong> The unintended byproduct of the words you use, a lease on an unabridged self.</p>`);
        
        createDefinitionBox('bottom', bottomBounds, `<p><strong>Body:</strong> Incongruency making due with the motherly press of gravity.</p>
<p><strong>Words:</strong> Rooming into your mouth, pushing sound against the inside of your cheeks like a rougher lover.</p>
<p><strong>Replacement:</strong> Rougher displacement.</p>`);
        
        // Hide word columns completely
        setTimeout(() => {
          wordsGrid.style.display = 'none';
        }, 100);
      }, 1000);
    }

    function calculateGroupBoundsByRows(startRow, endRow) {
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      
      allWordBoxes.forEach(wordData => {
        if (wordData.row >= startRow && wordData.row < endRow) {
          const rect = wordData.element.getBoundingClientRect();
          
          if (rect.left < minX) minX = rect.left;
          if (rect.top < minY) minY = rect.top;
          if (rect.right > maxX) maxX = rect.right;
          if (rect.bottom > maxY) maxY = rect.bottom;
        }
      });
      
      return {
        left: minX,
        top: minY,
        width: maxX - minX,
        height: maxY - minY
      };
    }

    function createDefinitionBox(side, bounds, htmlContent) {
      const box = document.createElement('div');
      box.className = 'definition-box';
      box.innerHTML = htmlContent;
      
      // Ensure boxes stay on screen with proper padding
      const minTop = 120; // Below instruction box
      const minLeft = 20;
      const maxWidth = window.innerWidth - 40;
      
      const finalTop = Math.max(bounds.top, minTop);
      const finalLeft = Math.max(bounds.left, minLeft);
      const finalWidth = Math.min(bounds.width, maxWidth);
      
      box.style.left = `${finalLeft}px`;
      box.style.top = `${finalTop}px`;
      box.style.width = `${finalWidth}px`;
      box.style.minHeight = `${bounds.height}px`;
      
      document.body.appendChild(box);
      
      // Trigger fade in
      setTimeout(() => {
        box.classList.add('visible');
      }, 100);
    }

    // ==================== START ====================
    init();
  </script>
</body>
</html>

